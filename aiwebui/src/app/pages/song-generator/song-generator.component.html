<app-header></app-header>

<div class="song-generator-container">
  <!-- Main Content Grid -->
  <div class="generator-grid">
    <!-- Left Side: Song Creation Card -->
    <div class="song-creation-section">
      <mat-card class="song-creation-card">
        <mat-card-header>
          <mat-card-title>
            <i class="fas fa-magic"></i>
            Create Song
          </mat-card-title>
          <mat-card-subtitle>
            Generate new songs with AI - choose lyrics or instrumental
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="controls-content">

            <form [formGroup]="songForm" (ngSubmit)="onSubmit()">

                <!-- Mode Selection -->
                <div class="form-group">
                    <div class="segment-control">
                        <button
                            type="button"
                            class="segment-button"
                            [class.active]="!isInstrumental()"
                            [disabled]="isLoading"
                            (click)="setMode('song')">
                            <i class="fas fa-microphone"></i>
                            <span>With Lyrics</span>
                        </button>
                        <button
                            type="button"
                            class="segment-button"
                            [class.active]="isInstrumental()"
                            [disabled]="isLoading"
                            (click)="setMode('instrumental')">
                            <i class="fas fa-guitar"></i>
                            <span>Instrumental</span>
                        </button>
                    </div>
                </div>

                <!-- Title Field (always visible, required only for instrumental) -->
                <div class="form-group">
                    <label for="title">Title:<span class="required" *ngIf="isInstrumental()"> *</span></label>
                    <div class="prompt-input-group">
                        <input
                            id="title"
                            type="text"
                            formControlName="title"
                            placeholder="Enter song title (max 50 characters)..."
                            [required]="isInstrumental()"
                            maxlength="50"
                            [disabled]="isLoading"
                            class="title-input">
                        <div class="title-dropdown-container">
                            <button
                                type="button"
                                (click)="toggleTitleDropdown()"
                                [disabled]="isLoading || isGeneratingTitle"
                                class="magic-icon-button"
                                title="Title actions">
                                <i class="fas fa-ellipsis-vertical" *ngIf="!isGeneratingTitle"></i>
                                <i class="fas fa-spinner fa-spin" *ngIf="isGeneratingTitle"></i>
                            </button>
                            <div class="dropdown-menu" *ngIf="showTitleDropdown" (click)="$event.stopPropagation()">
                                <button
                                    type="button"
                                    class="dropdown-item"
                                    [disabled]="isLoading || isGeneratingTitle"
                                    (click)="selectTitleAction('generate')">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    <span>Generate Title</span>
                                    <i class="fas fa-spinner fa-spin action-spinner" *ngIf="isGeneratingTitle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="char-counter">{{ songForm.get('title')?.value?.length || 0 }}/50</div>
                </div>

                <div class="form-group">
                    <label for="lyrics">Lyrics:</label>
                    <div class="prompt-input-group" [class.disabled-section]="isInstrumental()">
                        <textarea
                            id="lyrics"
                            formControlName="lyrics"
                            placeholder="Type your lyrics or a song idea here..."
                            [required]="!isInstrumental()"
                            [disabled]="isLoading || isInstrumental()"
                            class="lyrics-input">
                        </textarea>
                        <div class="lyrics-dropdown-container">
                            <button
                                type="button"
                                (click)="toggleLyricsDropdown()"
                                [disabled]="isLoading || isGeneratingLyrics || isTranslatingLyrics || isImprovingPrompt || !songForm.get('lyrics')?.value?.trim() || isInstrumental()"
                                class="magic-icon-button"
                                title="Lyrics actions">
                                <i class="fas fa-ellipsis-vertical" *ngIf="!isGeneratingLyrics && !isTranslatingLyrics"></i>
                                <i class="fas fa-spinner fa-spin" *ngIf="isGeneratingLyrics || isTranslatingLyrics"></i>
                            </button>
                            <div class="dropdown-menu" *ngIf="showLyricsDropdown && !isInstrumental()" (click)="$event.stopPropagation()">
                                <button
                                    type="button"
                                    class="dropdown-item"
                                    [disabled]="isLoading || isGeneratingLyrics || isTranslatingLyrics || isImprovingPrompt"
                                    (click)="selectLyricsAction('generate')">
                                    <i class="fas fa-music"></i>
                                    <span>Create Lyrics</span>
                                    <i class="fas fa-spinner fa-spin action-spinner" *ngIf="isGeneratingLyrics"></i>
                                </button>
                                <button
                                    type="button"
                                    class="dropdown-item"
                                    [disabled]="isLoading || isGeneratingLyrics || isTranslatingLyrics || isImprovingPrompt"
                                    (click)="selectLyricsAction('translate')">
                                    <i class="fas fa-language"></i>
                                    <span>Translate to English</span>
                                    <i class="fas fa-spinner fa-spin action-spinner" *ngIf="isTranslatingLyrics"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="instrumental-notice" *ngIf="isInstrumental()">
                        <i class="fas fa-info-circle"></i>
                        Lyrics are disabled for instrumental songs
                    </div>
                </div>

                <div class="form-group">
                    <label for="prompt">Music Style Prompt:</label>
                    <div class="prompt-input-group">
                        <textarea
                            id="prompt"
                            formControlName="prompt"
                            placeholder="Describe the music style (e.g., upbeat pop, melancholic ballad, rock anthem)..."
                            required
                            [disabled]="isLoading"
                            class="prompt-input">
                        </textarea>
                        <div class="style-dropdown-container">
                            <button
                                type="button"
                                (click)="toggleStyleDropdown()"
                                [disabled]="isLoading || isImprovingPrompt || isTranslatingLyrics || isGeneratingLyrics || isTranslatingStylePrompt || !songForm.get('prompt')?.value?.trim()"
                                class="magic-icon-button"
                                title="Music style actions">
                                <i class="fas fa-ellipsis-vertical" *ngIf="!isImprovingPrompt && !isTranslatingStylePrompt"></i>
                                <i class="fas fa-spinner fa-spin" *ngIf="isImprovingPrompt || isTranslatingStylePrompt"></i>
                            </button>
                            <div class="dropdown-menu" *ngIf="showStyleDropdown" (click)="$event.stopPropagation()">
                                <button
                                    type="button"
                                    class="dropdown-item"
                                    [disabled]="isLoading || isImprovingPrompt || isTranslatingLyrics || isGeneratingLyrics || isTranslatingStylePrompt"
                                    (click)="selectStyleAction('enhance')">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    <span>Enhance Style Prompt</span>
                                    <i class="fas fa-spinner fa-spin action-spinner" *ngIf="isImprovingPrompt"></i>
                                </button>
                                <button
                                    type="button"
                                    class="dropdown-item"
                                    [disabled]="isLoading || isImprovingPrompt || isTranslatingLyrics || isGeneratingLyrics || isTranslatingStylePrompt"
                                    (click)="selectStyleAction('translate')">
                                    <i class="fas fa-language"></i>
                                    <span>Translate to English</span>
                                    <i class="fas fa-spinner fa-spin action-spinner" *ngIf="isTranslatingStylePrompt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="model">Model:</label>
                    <select id="model" formControlName="model" required [disabled]="isLoading" class="model-select">
                        <option value="auto">Auto</option>
                        <option value="mureka-7.5">Mureka 7.5</option>
                        <option value="mureka-7">Mureka 7</option>
                        <option value="mureka-6">Mureka 6</option>
                        <option value="mureka-o1">Mureka o1</option>
                    </select>
                </div>

                <div class="button-group">
                    <button type="submit" [disabled]="songForm.invalid || isLoading || isImprovingPrompt || isTranslatingLyrics || isGeneratingLyrics || isTranslatingStylePrompt || isGeneratingTitle" class="create-button">
                        <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
                        <i class="fas fa-music" *ngIf="!isLoading"></i>
                        {{ isLoading ? 'Creating...' : (isInstrumental() ? 'Create Instrumental' : 'Create Song') }}
                    </button>
                    <button type="button" (click)="resetForm()" [disabled]="isLoading || isImprovingPrompt || isTranslatingLyrics || isGeneratingLyrics || isTranslatingStylePrompt || isGeneratingTitle" class="reset-button">
                        <i class="fas fa-rotate-left"></i> Reset
                    </button>
                </div>

              <div *ngIf="isLoading && loadingMessage" class="loading-status">
                <small class="loading-text">
                  <i class="fas fa-info-circle"></i>
                  {{ loadingMessage }} - This may take several minutes
                </small>
              </div>
            </form>
          </div>
        </mat-card-content>
        <mat-card-actions align="end">
          <p class="cost-info">
            <i class="fas fa-info-circle"></i>
            Song generation: ~$0.15 each
          </p>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Right Side: Generated Song Card -->
    <div class="generated-song-section">
      <mat-card class="generated-song-card">
        <mat-card-header>
          <mat-card-title>
            <i class="fas fa-music"></i>
            Generated Song
          </mat-card-title>
          <mat-card-subtitle>
            Listen to and manage your newly created song
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <app-song-detail-panel
              #songDetailPanel
              [songId]="currentSongId"
              [showEditTitle]="true"
              [showEditTags]="true"
              [showEditWorkflow]="true"
              [showRating]="true"
              [isGenerating]="isLoading"
              title=""
              [showMetaInfo]="['job_id', 'model', 'status', 'created', 'completed']"
              placeholderText="Your generated song will appear here"
              [currentlyPlayingId]="currentlyPlaying"
              (titleChanged)="onTitleChanged($event)"
              (tagsChanged)="onTagsChanged($event)"
              (workflowChanged)="onWorkflowChanged($event)"
              (downloadFlac)="onDownloadFlac($event)"
              (playAudio)="onPlayAudio($event)"
              (downloadStems)="onDownloadStems($event)"
              (copyLyrics)="onCopyLyrics()"
              (updateRating)="onUpdateRating($event)">
          </app-song-detail-panel>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Popup Audio Player -->
<app-popup-audio-player
  [visible]="showPopupPlayer"
  [audioUrl]="audioUrl"
  [songTitle]="currentSongTitle"
  (closePlayer)="onPopupPlayerClose()"
  (audioEnded)="onPopupPlayerEnded()"
  (audioLoadError)="onAudioLoadError($event)">
</app-popup-audio-player>


<app-footer></app-footer>
